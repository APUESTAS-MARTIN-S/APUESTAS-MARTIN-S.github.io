<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Apuestas Martin's ‚Äì Boletas Chontico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #022c22;
      --card: #021813;
      --accent: #22c55e;
      --accent-strong: #16a34a;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(34,197,94,0.45);
      --shadow-soft: 0 18px 35px rgba(4, 23, 16, 0.85);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #047857 0, #022c22 45%, #01100c 100%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    main {
      width: 100%;
      max-width: 1080px;
      background: linear-gradient(145deg, rgba(6,78,59,0.98), rgba(3,47,36,0.99));
      border-radius: 26px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 20px 18px 18px;
      position: relative;
      overflow: hidden;
    }

    main::before,
    main::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      filter: blur(45px);
      opacity: 0.35;
      pointer-events: none;
    }

    main::before {
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(34,197,94,0.7), transparent 60%);
      top: -90px;
      right: -70px;
    }

    main::after {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(21,128,61,0.7), transparent 60%);
      bottom: -80px;
      left: -40px;
    }

    .content { position: relative; z-index: 1; }

    .banner {
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(22,163,74,0.7);
      box-shadow: 0 14px 32px rgba(4,20,14,0.95);
      margin-bottom: 18px;
      background: #064e3b;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
    }

    .banner-img {
      width: 100%;
      max-height: 260px;
      object-fit: contain;
      display: block;
    }

    .header-brand {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark-img {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(34,197,94,0.65);
      box-shadow: 0 0 0 1px rgba(3,24,17,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #064e3b;
    }

    .logo-mark-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .logo-text-main {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 18px;
      letter-spacing: 0.03em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .tag-age {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(1,17,13,0.96);
      border: 1px solid rgba(22,163,74,0.7);
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .tag-age span.badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(248,250,252,0.06);
      color: #e5e7eb;
      font-size: 11px;
      font-weight: 600;
    }

    @media (max-width: 640px) {
      .header-brand { flex-direction: column; align-items: flex-start; }
    }

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 20px;
      margin-bottom: 18px;
    }

    @media (max-width: 820px) { .hero { grid-template-columns: 1fr; } }

    .hero-left { display: flex; flex-direction: column; gap: 10px; }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(3,24,17,0.9);
      border: 1px solid rgba(34,197,94,0.7);
      font-size: 11px;
      color: var(--text-muted);
      width: fit-content;
    }

    .eyebrow span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #e5e7eb;
    }

    .title {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: clamp(24px, 3.6vw, 30px);
      line-height: 1.2;
      letter-spacing: 0.01em;
    }

    .title strong { color: var(--accent); }

    .flag { font-size: 0.8em; margin-left: 4px; }

    .hero-right {
      background: rgba(1,17,13,0.98);
      border-radius: 18px;
      border: 1px solid rgba(22,163,74,0.7);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hero-right-title { font-size: 13px; color: var(--text-muted); margin-bottom: 2px; }

    .pill-row { display: flex; flex-wrap: wrap; gap: 8px; }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(1,17,13,1);
      border: 1px solid rgba(22,163,74,0.6);
      font-size: 11px;
      color: #e5e7eb;
    }

    .pill strong { color: var(--accent); font-weight: 600; }

    .finder-section {
      background: rgba(1,17,13,0.98);
      border-radius: 18px;
      border: 1px solid rgba(22,163,74,0.7);
      padding: 12px 12px 14px;
      margin-bottom: 18px;
    }

    .finder-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }

    .finder-title { font-size: 15px; font-weight: 600; }
    .finder-note { font-size: 12px; color: var(--text-muted); }

    @media (max-width: 640px) {
      .finder-header { flex-direction: column; align-items: flex-start; }
    }

    .finder-controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .finder-label { font-size: 13px; }

    .finder-select {
      min-width: 140px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      background: #02130f;
      color: var(--text-main);
      font-size: 14px;
    }

    .finder-select:focus {
      outline: none;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-strong);
    }

    @media (max-width: 640px) {
      .finder-controls-row { flex-direction: column; align-items: flex-start; }
      .finder-select { width: 100%; }
    }

    .finder-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .dino-inline-img {
      max-width: 230px;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(34,197,94,0.7);
      box-shadow: 0 10px 22px rgba(2,23,16,0.9);
      background: #022c22;
    }

    .dino-inline-img img {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s, border-color 0.1s, opacity 0.1s;
      white-space: nowrap;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 12px 25px rgba(22,163,74,0.6);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(22,163,74,0.8);
    }

    .tickets-table-wrapper {
      margin-top: 8px;
      max-height: 360px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(7,43,29,0.95);
      background: #020f0b;
    }

    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .tickets-table thead {
      position: sticky;
      top: 0;
      background: #059669;
      z-index: 1;
    }

    .tickets-table th,
    .tickets-table td {
      padding: 7px 8px;
      text-align: left;
    }

    .tickets-table th {
      font-weight: 600;
      color: #f9fafb;
      border-bottom: 1px solid #022c22;
    }

    .tickets-table tbody tr:nth-child(even) { background: #020f0b; }
    .tickets-table tbody tr:nth-child(odd)  { background: #031611; }

    .num-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 52px;
      padding: 6px 0;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      background: radial-gradient(circle at 30% 20%, #065f46, #022c22);
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 15px;
      cursor: pointer;
    }

    .num-pill.selected {
      box-shadow: 0 0 0 2px #ecfeff, 0 0 0 3px #22c55e;
    }

    .cell-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: #020f0b;
      color: var(--text-main);
      padding: 5px 8px;
      font-size: 12px;
    }

    .cell-input:focus {
      outline: none;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-strong);
    }

    .badge-status {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
      text-align: center;
      min-width: 80px;
    }

    .badge-status.disponible {
      background: rgba(22,163,74,0.18);
      border-color: rgba(34,197,94,0.8);
      color: #bbf7d0;
    }

    .badge-status.reservado {
      background: rgba(251,191,36,0.16);
      border-color: rgba(250,204,21,0.9);
      color: #fef3c7;
    }

    .badge-status.pagado {
      background: rgba(37,99,235,0.18);
      border-color: rgba(37,99,235,0.9);
      color: #dbeafe;
    }

    /* Nuevo estado: ABONADO */
    .badge-status.abonado {
      background: rgba(168,85,247,0.14);
      border-color: rgba(168,85,247,0.85);
      color: #f3e8ff;
    }

    .btn-row {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-row.disabled {
      opacity: 0.5;
      cursor: default;
      background: #1f2937;
      border-color: rgba(107,114,128,0.8);
    }

    .hint-cell {
      font-size: 10px;
      color: var(--text-muted);
      padding-top: 4px;
    }

    .payments {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 14px;
      margin-bottom: 10px;
    }

    @media (max-width: 780px) { .payments { grid-template-columns: 1fr; } }

    .payments-card {
      background: rgba(1,17,13,0.98);
      border-radius: 16px;
      border: 1px solid rgba(22,163,74,0.7);
      padding: 10px 12px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .payments-title { font-size: 14px; font-weight: 600; }

    .payments-list-vertical {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .payments-list-vertical li {
      padding: 6px 8px;
      border-radius: 10px;
      background: var(--card);
      border: 1px solid rgba(22,163,74,0.7);
      line-height: 1.4;
    }

    .payments-list-vertical strong {
      display: block;
      margin-bottom: 2px;
    }

    .payments-note-small {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .footer {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      cursor: pointer; /* para que parezca clicable */
    }

    /* Panel administrador */
    #admin-panel {
      position: fixed;
      bottom: 14px;
      right: 14px;
      width: 290px;
      max-width: calc(100% - 28px);
      background: #020f0b;
      border-radius: 14px;
      border: 1px solid rgba(22,163,74,0.7);
      box-shadow: 0 16px 32px rgba(1,15,11,0.95);
      padding: 10px 12px 12px;
      font-size: 12px;
      color: var(--text-main);
      z-index: 60;
      display: none;
    }

    #admin-panel-title { font-weight: 600; margin-bottom: 4px; }

    #admin-panel-note {
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 6px;
    }

    .admin-select {
      width: 100%;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      background: #02130f;
      color: var(--text-main);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .admin-select:focus {
      outline: none;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-strong);
    }

    #admin-status { margin-bottom: 6px; }

    .admin-buttons {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 4px;
      margin-bottom: 6px;
    }

    .admin-btn-small {
      padding: 5px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020f0b;
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }

    .admin-btn-small:hover { background: #022c22; }

    #admin-export,
    #admin-reset-week {
      width: 100%;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.7);
      background: #022c22;
      color: #bbf7d0;
      font-size: 11px;
      cursor: pointer;
      margin-top: 4px;
    }

    #admin-export:hover,
    #admin-reset-week:hover { background: #065f46; }

    #admin-close {
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
    }

    #admin-close:hover { color: #e5e7eb; }
  </style>
</head>
<body>
  <main>
    <div class="content">
      <section class="banner">
        <img src="logo.jpeg" alt="Apuestas Martin's" class="banner-img">
      </section>

      <header class="header-brand">
        <div class="logo">
          <div class="logo-mark-img">
            <img src="dino.jpg" alt="Dino Martin's">
          </div>
          <div>
            <div class="logo-text-main">Apuestas Martin's</div>
            <div class="logo-text-sub">Boletas Chontico</div>
          </div>
        </div>
        <!-- ELIMINADO (tachado): bloque +18 / Solo mayores de edad -->
      </header>

      <section class="hero">
        <div class="hero-left">
          <div class="eyebrow"><span>Boletas Chontico</span></div>
          <h2 class="title">
            Valores en <strong>CLP<span class="flag">üá®üá±</span></strong> y
            <strong>COP<span class="flag">üá®üá¥</span></strong>.
          </h2>
        </div>
        <aside class="hero-right">
          <div class="hero-right-title">Valores por tipo de boleta</div>
          <div class="pill-row">
            <div class="pill">
              <strong>CHONTICO D√çA</strong><br>
              Lunes a S√°bado: $2.000 CLP ¬∑ $8.000 COP<br>
              Domingo: $1.000 CLP ¬∑ $4.000 COP
            </div>
            <div class="pill">
              <strong>CHONTICO NOCHE</strong><br>
              Lunes a Viernes: $2.000 CLP ¬∑ $8.000 COP<br>
              S√°bado y Domingo: $3.000 CLP ¬∑ $12.000 COP
            </div>
          </div>
        </aside>
      </section>

      <section class="finder-section">
        <div class="finder-header">
          <h3 class="finder-title">N√∫mero de boleta</h3>
          <!-- ELIMINADO (tachado): texto de ayuda -->
        </div>

        <div class="finder-controls-row">
          <span class="finder-label">Tipo:</span>
          <select id="tipo-select" class="finder-select"></select>
          <span class="finder-label">D√≠a:</span>
          <select id="dia-select" class="finder-select"></select>
        </div>

        <div class="finder-actions">
          <div class="dino-inline-img">
            <img src="dino.jpg" alt="Dino Martin's">
          </div>
          <a
            href="https://wa.me/573125172779?text=Hola%2C%20quiero%20ayuda%20con%20las%20boletas%20de%20Chontico."
            target="_blank"
            class="btn btn-primary"
          >
            Escr√≠beme y te ayudo
          </a>
        </div>

        <div class="tickets-table-wrapper">
          <table class="tickets-table">
            <thead>
              <tr>
                <th style="width:70px;">N√∫mero</th>
                <th>Nombre</th>
                <th style="width:150px;">Celular</th>
                <th style="width:110px;">Estado</th>
                <th style="width:110px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tickets-table-body"></tbody>
          </table>
        </div>
        <!-- ELIMINADO (tachado): texto inferior de celular -->
      </section>

      <section class="payments">
        <div class="payments-card">
          <div class="payments-title">Cuentas en CHILE üá®üá±</div>
          <ul class="payments-list-vertical">
            <li>
              <strong>1. Leidy Saavedra</strong>
              RUT: 25.407.964-2<br>
              Banco Falabella ¬∑ Cuenta Corriente<br>
              N.¬∫ 1-983-252078-3
            </li>
            <li>
              <strong>2. Jeferson Valencia</strong>
              Banco Estado ¬∑ Cuenta Rut<br>
              N.¬∫ 26.196.885-1
            </li>
            <li>
              <strong>3. Leidy Saavedra</strong>
              Banco Estado ¬∑ Cuenta Rut<br>
              N.¬∫ 25.407.964-2
            </li>
          </ul>
          <div class="payments-note-small">
            Se recomienda realizar pagos principalmente a la cuenta de Falabella.
          </div>
        </div>

        <div class="payments-card">
          <div class="payments-title">Cuenta en COLOMBIA üá®üá¥</div>
          <ul class="payments-list-vertical">
            <li>
              <strong>1. Leidy Saavedra</strong>
              NEQUI<br>
              N.¬∫ 3118618775
            </li>
          </ul>
          <div class="payments-note-small">
            Se actualizan las cuentas por temas de fiscalizaci√≥n.
          </div>
        </div>
      </section>

      <!-- Frase que ahora sirve como bot√≥n oculto de administrador -->
      <footer class="footer" id="admin-footer-trigger">
        <!-- ELIMINADO (tachado): texto del footer -->
      </footer>
    </div>
  </main>

  <!-- Panel administrador -->
  <div id="admin-panel" aria-hidden="true">
    <button id="admin-close" type="button" title="Cerrar">√ó</button>
    <div id="admin-panel-title">Modo administrador</div>
    <div id="admin-panel-note">
      Cambia estados, limpia datos y descarga reservas en CSV. Atajo en PC: <strong>Ctrl + Shift + A</strong>.
    </div>

    <select id="admin-tipo" class="admin-select"></select>
    <select id="admin-dia" class="admin-select"></select>
    <select id="admin-select" class="admin-select"></select>

    <div id="admin-status"></div>

    <div class="admin-buttons">
      <button id="admin-disponible" class="admin-btn-small">Disponible</button>
      <button id="admin-reservado" class="admin-btn-small">Reservado</button>
      <button id="admin-pagado" class="admin-btn-small">Pagado</button>
      <button id="admin-abonado" class="admin-btn-small">Abonado</button>
    </div>
    <button id="admin-clear-name" class="admin-btn-small" style="width:100%; margin-bottom:6px;">
      Borrar nombre y celular
    </button>

    <button id="admin-reset-week">Reiniciar semana (todo disponible)</button>
    <button id="admin-export">Descargar CSV (Excel)</button>
  </div>

  <!-- Firebase v8 (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJ-Q-TFJ7jNVJtlb6d8x5-q2pq0hKbca0",
      authDomain: "apuestas-manrtin-s.firebaseapp.com",
      databaseURL: "https://apuestas-manrtin-s-default-rtdb.firebaseio.com",
      projectId: "apuestas-manrtin-s",
      storageBucket: "apuestas-manrtin-s.firebasestorage.app",
      messagingSenderId: "207853884414",
      appId: "1:207853884414:web:67e81dcc4c4aa3d4ffa6af",
      measurementId: "G-3RLTFV4S7T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    (function () {
      const TOTAL_NUMBERS = 100; // 00‚Äì99
      const TIPOS = [
        { id: "dia",   label: "Chontico D√≠a" },
        { id: "noche", label: "Chontico Noche" }
      ];
      const DIAS = [
        { id: "lun", label: "Lunes" },
        { id: "mar", label: "Martes" },
        { id: "mie", label: "Mi√©rcoles" },
        { id: "jue", label: "Jueves" },
        { id: "vie", label: "Viernes" },
        { id: "sab", label: "S√°bado" },
        { id: "dom", label: "Domingo" }
      ];
      const ESTADOS = {
        DISPONIBLE: "disponible",
        RESERVADO: "reservado",
        PAGADO: "pagado",
        ABONADO: "abonado"
      };

      const tipoSelect = document.getElementById("tipo-select");
      const diaSelect = document.getElementById("dia-select");
      const tableBody = document.getElementById("tickets-table-body");

      const adminTrigger = document.getElementById("admin-footer-trigger");
      const adminPanel = document.getElementById("admin-panel");
      const adminTipoSelect = document.getElementById("admin-tipo");
      const adminDiaSelect = document.getElementById("admin-dia");
      const adminSelect = document.getElementById("admin-select");
      const adminStatus = document.getElementById("admin-status");
      const adminDisponible = document.getElementById("admin-disponible");
      const adminReservado = document.getElementById("admin-reservado");
      const adminPagado = document.getElementById("admin-pagado");
      const adminAbonado = document.getElementById("admin-abonado");
      const adminClearName = document.getElementById("admin-clear-name");
      const adminExport = document.getElementById("admin-export");
      const adminResetWeek = document.getElementById("admin-reset-week");
      const adminClose = document.getElementById("admin-close");

      let data = {};
      let selectedIndex = null;
      let ready = false;
      let adminUnlocked = false;

      function formatNumber(n) {
        return n.toString().padStart(2, "0");
      }

      function defaultRegistro() {
        return { estado: ESTADOS.DISPONIBLE, nombre: "", celular: "" };
      }

      function buildDefaultData() {
        const obj = {};
        TIPOS.forEach(t => {
          obj[t.id] = {};
          DIAS.forEach(d => {
            obj[t.id][d.id] = Array.from({ length: TOTAL_NUMBERS }, defaultRegistro);
          });
        });
        return obj;
      }

      function mergeRemote(remote) {
        const base = buildDefaultData();
        if (!remote || typeof remote !== "object") return base;

        TIPOS.forEach(t => {
          DIAS.forEach(d => {
            const arrR = (remote[t.id] && remote[t.id][d.id]) || [];
            arrR.forEach((r, idx) => {
              if (idx < TOTAL_NUMBERS && r && typeof r === "object") {
                base[t.id][d.id][idx] = {
                  estado: r.estado || ESTADOS.DISPONIBLE,
                  nombre: r.nombre || "",
                  celular: r.celular || ""
                };
              }
            });
          });
        });
        return base;
      }

      function currentTipoId() {
        return tipoSelect.value || TIPOS[0].id;
      }
      function currentDiaId() {
        return diaSelect.value || DIAS[0].id;
      }

      function labelTipo(id) {
        const t = TIPOS.find(x => x.id === id);
        return t ? t.label : id;
      }
      function labelDia(id) {
        const d = DIAS.find(x => x.id === id);
        return d ? d.label : id;
      }

      function statusToText(estado) {
        if (estado === ESTADOS.RESERVADO) return "Reservado";
        if (estado === ESTADOS.PAGADO) return "Pagado";
        if (estado === ESTADOS.ABONADO) return "Abonado";
        return "Disponible";
      }

      function validatePhone(value) {
        const clean = value.replace(/\D/g, "");
        if (clean.length === 9 || clean.length === 10) {
          return clean;
        }
        return null;
      }

      function writeRegistro(tipoId, diaId, index) {
        const reg = data[tipoId][diaId][index];
        db.ref("boletas/" + tipoId + "/" + diaId + "/" + index)
          .set(reg)
          .then(function () {
            console.log("Guardado OK:", tipoId, diaId, index);
          })
          .catch(function (error) {
            console.error("Error al guardar:", error);
            alert("No se pudo guardar la boleta. Revisa las reglas de Firebase (lectura/escritura) o la conexi√≥n a internet.");
          });
      }

      function buildRow(tipoId, diaId, index) {
        const registro = data[tipoId][diaId][index];
        const tr = document.createElement("tr");
        tr.dataset.index = String(index);

        const tdNum = document.createElement("td");
        const numBtn = document.createElement("button");
        numBtn.type = "button";
        numBtn.className = "num-pill";
        numBtn.textContent = formatNumber(index);
        tdNum.appendChild(numBtn);

        const tdNombre = document.createElement("td");
        const inputNombre = document.createElement("input");
        inputNombre.type = "text";
        inputNombre.className = "cell-input";
        inputNombre.value = registro.nombre || "";
        inputNombre.placeholder = "Nombre";
        tdNombre.appendChild(inputNombre);

        const tdCel = document.createElement("td");
        const inputCel = document.createElement("input");
        inputCel.type = "tel";
        inputCel.className = "cell-input";
        inputCel.placeholder = "9 o 10 d√≠gitos";
        if (registro.estado === ESTADOS.DISPONIBLE) {
          inputCel.value = registro.celular || "";
        } else {
          inputCel.value = "";
          inputCel.style.display = "none";
          const spanInfo = document.createElement("div");
          spanInfo.className = "hint-cell";
          spanInfo.textContent = "Registrado";
          tdCel.appendChild(spanInfo);
        }
        tdCel.appendChild(inputCel);

        const tdEstado = document.createElement("td");
        const spanEstado = document.createElement("span");
        spanEstado.className = "badge-status " + registro.estado;
        spanEstado.textContent = statusToText(registro.estado);
        tdEstado.appendChild(spanEstado);

        const tdAccion = document.createElement("td");
        const btnAccion = document.createElement("button");
        btnAccion.type = "button";
        btnAccion.className = "btn-row";
        btnAccion.textContent = "Apartar";

        if (registro.estado !== ESTADOS.DISPONIBLE) {
          if (registro.estado === ESTADOS.RESERVADO) btnAccion.textContent = "Reservado";
          else if (registro.estado === ESTADOS.PAGADO) btnAccion.textContent = "Pagado";
          else if (registro.estado === ESTADOS.ABONADO) btnAccion.textContent = "Abonado";
          btnAccion.classList.add("disabled");
        }
        tdAccion.appendChild(btnAccion);

        tr.appendChild(tdNum);
        tr.appendChild(tdNombre);
        tr.appendChild(tdCel);
        tr.appendChild(tdEstado);
        tr.appendChild(tdAccion);

        // Regla: ABONADO no puede ser modificado ni reservado por clientes
        if (registro.estado === ESTADOS.ABONADO) {
          inputNombre.disabled = true;
          inputCel.disabled = true;
        }

        numBtn.addEventListener("click", function () {
          selectedIndex = index;
          highlightSelected();
        });

        btnAccion.addEventListener("click", function () {
          if (registro.estado !== ESTADOS.DISPONIBLE) return;
          if (registro.estado === ESTADOS.ABONADO) return;

          const nombre = inputNombre.value.trim();
          if (!nombre) {
            alert("Por favor escribe un nombre para apartar la boleta.");
            return;
          }

          const celRaw = inputCel.value.trim();
          if (!celRaw) {
            alert("Por favor escribe el celular (9 d√≠gitos Chile o 10 d√≠gitos Colombia).");
            return;
          }
          const celValid = validatePhone(celRaw);
          if (!celValid) {
            alert("El celular debe tener 9 d√≠gitos (Chile) o 10 d√≠gitos (Colombia), solo n√∫meros.");
            return;
          }

          registro.nombre = nombre;
          registro.celular = celValid;
          registro.estado = ESTADOS.RESERVADO;

          writeRegistro(tipoId, diaId, index);
        });

        inputNombre.addEventListener("change", function () {
          if (registro.estado === ESTADOS.ABONADO) return;
          registro.nombre = inputNombre.value.trim();
          writeRegistro(tipoId, diaId, index);
        });

        inputCel.addEventListener("change", function () {
          if (registro.estado === ESTADOS.ABONADO) return;
          if (registro.estado === ESTADOS.DISPONIBLE) {
            registro.celular = inputCel.value.trim();
            writeRegistro(tipoId, diaId, index);
          }
        });

        return tr;
      }

      function highlightSelected() {
        const rows = tableBody.querySelectorAll("tr");
        rows.forEach(row => {
          const idx = parseInt(row.dataset.index, 10);
          const pill = row.querySelector(".num-pill");
          if (!pill) return;
          if (selectedIndex === idx) {
            pill.classList.add("selected");
          } else {
            pill.classList.remove("selected");
          }
        });
      }

      function rebuildTable() {
        if (!ready) return;
        const tId = currentTipoId();
        const dId = currentDiaId();
        tableBody.innerHTML = "";
        for (let i = 0; i < TOTAL_NUMBERS; i++) {
          tableBody.appendChild(buildRow(tId, dId, i));
        }
        highlightSelected();
      }

      function clearSelection() {
        selectedIndex = null;
        highlightSelected();
      }

      function toggleAdminPanel(show) {
        const visible = show !== undefined ? show : adminPanel.style.display !== "block";
        adminPanel.style.display = visible ? "block" : "none";
      }

      function currentAdminTipo() {
        return adminTipoSelect.value || TIPOS[0].id;
      }
      function currentAdminDia() {
        return adminDiaSelect.value || DIAS[0].id;
      }
      function currentAdminIndex() {
        const idx = parseInt(adminSelect.value, 10);
        return isNaN(idx) ? 0 : idx;
      }

      function updateAdminStatus() {
        if (!ready) return;
        const tId = currentAdminTipo();
        const dId = currentAdminDia();
        const idx = currentAdminIndex();
        const registro = data[tId][dId][idx];

        adminStatus.textContent =
          "Tipo: " + labelTipo(tId) +
          " ¬∑ D√≠a: " + labelDia(dId) +
          " ¬∑ N¬∫ " + formatNumber(idx) +
          " ¬∑ Estado: " + statusToText(registro.estado) +
          " ¬∑ Nombre: " + (registro.nombre || "-");
      }

      function adminSetEstado(estado) {
        const tId = currentAdminTipo();
        const dId = currentAdminDia();
        const idx = currentAdminIndex();
        const registro = data[tId][dId][idx];
        registro.estado = estado;
        writeRegistro(tId, dId, idx);
      }

      function initSelectors() {
        TIPOS.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.label;
          tipoSelect.appendChild(opt);

          const optAdmin = document.createElement("option");
          optAdmin.value = t.id;
          optAdmin.textContent = t.label;
          adminTipoSelect.appendChild(optAdmin);
        });

        DIAS.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.label;
          diaSelect.appendChild(opt);

          const optAdmin = document.createElement("option");
          optAdmin.value = d.id;
          optAdmin.textContent = d.label;
          adminDiaSelect.appendChild(optAdmin);
        });

        for (let i = 0; i < TOTAL_NUMBERS; i++) {
          const optAdmin = document.createElement("option");
          optAdmin.value = String(i);
          optAdmin.textContent = formatNumber(i);
          adminSelect.appendChild(optAdmin);
        }

        tipoSelect.value = TIPOS[0].id;
        diaSelect.value = DIAS[0].id;
        adminTipoSelect.value = TIPOS[0].id;
        adminDiaSelect.value = DIAS[0].id;
        adminSelect.value = "0";

        tipoSelect.addEventListener("change", function () {
          clearSelection();
          rebuildTable();
        });
        diaSelect.addEventListener("change", function () {
          clearSelection();
          rebuildTable();
        });

        adminTipoSelect.addEventListener("change", updateAdminStatus);
        adminDiaSelect.addEventListener("change", updateAdminStatus);
        adminSelect.addEventListener("change", updateAdminStatus);
      }

      adminDisponible.addEventListener("click", function () {
        const tId = currentAdminTipo();
        const dId = currentAdminDia();
        const idx = currentAdminIndex();
        const registro = data[tId][dId][idx];
        registro.estado = ESTADOS.DISPONIBLE;
        registro.nombre = "";
        registro.celular = "";
        writeRegistro(tId, dId, idx);
      });

      adminReservado.addEventListener("click", function () {
        adminSetEstado(ESTADOS.RESERVADO);
      });

      adminPagado.addEventListener("click", function () {
        adminSetEstado(ESTADOS.PAGADO);
      });

      adminAbonado.addEventListener("click", function () {
        adminSetEstado(ESTADOS.ABONADO);
      });

      adminClearName.addEventListener("click", function () {
        const tId = currentAdminTipo();
        const dId = currentAdminDia();
        const idx = currentAdminIndex();
        const registro = data[tId][dId][idx];
        registro.nombre = "";
        registro.celular = "";
        writeRegistro(tId, dId, idx);
      });

      adminExport.addEventListener("click", function () {
        const rows = [];
        TIPOS.forEach(t => {
          DIAS.forEach(d => {
            data[t.id][d.id].forEach((reg, idx) => {
              if (reg.estado !== ESTADOS.DISPONIBLE || reg.nombre || reg.celular) {
                rows.push({
                  tipo: labelTipo(t.id),
                  dia: labelDia(d.id),
                  numero: formatNumber(idx),
                  estado: statusToText(reg.estado),
                  nombre: reg.nombre || "",
                  celular: reg.celular || ""
                });
              }
            });
          });
        });

        if (rows.length === 0) {
          alert("No hay reservas para exportar.");
          return;
        }

        let csv = "Tipo;D√≠a;N√∫mero;Estado;Nombre;Celular\r\n";
        rows.forEach(r => {
          csv += r.tipo + ";" + r.dia + ";" + r.numero + ";" +
                 r.estado + ";" + r.nombre + ";" + r.celular + "\r\n";
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "reservas_chontico.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      adminResetWeek.addEventListener("click", function () {
        if (!confirm("¬øSeguro que quieres reiniciar toda la semana? Esto borrar√° todos los nombres, celulares y pondr√° todas las boletas en Disponible.")) {
          return;
        }

        // Regla: ABONADO NO se borra con reiniciar semana.
        const fresh = buildDefaultData();
        TIPOS.forEach(t => {
          DIAS.forEach(d => {
            data[t.id][d.id].forEach((reg, idx) => {
              if (reg && reg.estado === ESTADOS.ABONADO) {
                fresh[t.id][d.id][idx] = {
                  estado: reg.estado,
                  nombre: reg.nombre || "",
                  celular: reg.celular || ""
                };
              }
            });
          });
        });

        db.ref("boletas").set(fresh)
          .then(function () {
            alert("Semana reiniciada. Todas las boletas est√°n disponibles (excepto ABONADO).");
          })
          .catch(function (error) {
            console.error("Error al reiniciar la semana:", error);
            alert("No se pudo reiniciar la semana. Revisa la conexi√≥n o las reglas de Firebase.");
          });
      });

      function openAdminWithAuth() {
        if (!adminUnlocked) {
          const pwd = prompt("Contrase√±a de administrador:");
          if (pwd !== "Martin15.") {
            alert("Contrase√±a incorrecta.");
            return;
          }
          adminUnlocked = true;
        }
        toggleAdminPanel(true);
      }

      adminTrigger.addEventListener("click", function () {
        openAdminWithAuth();
      });

      adminClose.addEventListener("click", function () {
        toggleAdminPanel(false);
      });

      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.shiftKey && (e.key === "A" || e.key === "a")) {
          e.preventDefault();
          openAdminWithAuth();
        }
      });

      function init() {
        initSelectors();
        data = buildDefaultData();
        ready = true;
        rebuildTable();

        db.ref("boletas").on("value", function (snapshot) {
          data = mergeRemote(snapshot.val());
          ready = true;
          rebuildTable();
          updateAdminStatus();
          highlightSelected();
        });
      }

      init();
    })();
  </script>
</body>
</html>
